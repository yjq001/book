name: AIè‡ªä¸»ç­–ç•¥-Autonomous Daily V1 Trading

on:
  schedule:
    # æ¯å¤© UTC 15:30 æ‰§è¡Œ
    - cron: '30 15 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      autonomous_provider:
        description: 'LLM Provider'
        required: false
        type: choice
        default: 'gemini'
        options:
          - gemini
          - openai
          - openrouter
      autonomous_model:
        description: 'LLM Model name (leave empty to use default for selected provider)'
        required: false
        default: ''
      telegram_chat_id:
        description: 'Telegram Chat ID'
        required: false
        default: '-1003444893572'
      dry_run:
        description: 'Dry Run Mode (true/false)'
        required: false
        default: 'false'

jobs:
  run_autonomous_daily_v1:
    runs-on: ubuntu-latest
    
    steps:
      - name: Set LLM configuration based on provider
        id: set_llm_config
        run: |
          PROVIDER="${{ github.event.inputs.autonomous_provider || 'gemini' }}"
          CUSTOM_MODEL="${{ github.event.inputs.autonomous_model }}"
          
          # æ ¹æ®æä¾›å•†è®¾ç½®é»˜è®¤æ¨¡å‹
          case "$PROVIDER" in
            openai)
              DEFAULT_MODEL="gpt-4o-mini"
              ;;
            gemini)
              DEFAULT_MODEL="gemini-3-flash-preview"
              ;;
            openrouter)
              DEFAULT_MODEL="openai/gpt-4o-mini"
              ;;
            *)
              DEFAULT_MODEL="gemini-3-flash-preview"
              ;;
          esac
          
          # å¦‚æœç”¨æˆ·æä¾›äº†è‡ªå®šä¹‰æ¨¡å‹ï¼Œä½¿ç”¨è‡ªå®šä¹‰æ¨¡å‹ï¼›å¦åˆ™ä½¿ç”¨é»˜è®¤æ¨¡å‹
          if [ -n "$CUSTOM_MODEL" ]; then
            MODEL="$CUSTOM_MODEL"
          else
            MODEL="$DEFAULT_MODEL"
          fi
          
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Using provider: $PROVIDER, model: $MODEL"
      
      - name: Run autonomous daily v1 strategy
        run: |
          docker pull ghcr.io/yjq001/ibkr:latest
          
          docker run --rm --network host \
            --name autonomous_daily_v1 \
            \
            # ============ IBKR è¿æ¥é…ç½® ============
            -e USE_MOCK_BROKER=false \
            -e IBKR_HOST="${{ secrets.IBKR_HOST }}" \
            -e IBKR_PORT="${{ secrets.IBKR_PORT }}" \
            -e IBKR_CLIENT_ID=3 \
            -e IBKR_ACCOUNT="${{ secrets.IBKR_ACCOUNT_PAPER }}" \
            -e IBKR_REQUEST_TIMEOUT_S=120 \
            -e IBKR_MOCK=false \
            \
            # ============ äº¤æ˜“æ§åˆ¶ ============
            -e DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}" \
            -e STRATEGY_NAME="autonomous_daily_v1" \
            \
            # ============ LLM å¤§æ¨¡å‹é…ç½® ============
            -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            -e OPENAI_MODEL="gpt-4o-mini" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -e OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
            -e OPENROUTER_HTTP_REFERER="https://github.com/easyllms/ibkr-bot" \
            -e OPENROUTER_APP_NAME="IBKR Bot" \
            -e AUTONOMOUS_PROVIDER="${{ steps.set_llm_config.outputs.provider }}" \
            -e AUTONOMOUS_MODEL="${{ steps.set_llm_config.outputs.model }}" \
            -e LLM_STREAMING=true \
            -e STRATEGIST_PROVIDER="openai" \
            -e STRATEGIST_MODEL="o4-mini" \
            \
            # ============ MCP æœåŠ¡ ============
            -e MCP_SERVER_URL="${{ secrets.MCP_SERVER_URL }}" \
            \
            # ============ Upstash Redis ============
            -e UPSTASH_REDIS_URL="https://smashing-spaniel-32228.upstash.io" \
            -e UPSTASH_REDIS_TOKEN="${{ secrets.UPSTASH_REDIS_TOKEN }}" \
            \
            # ============ Telegram é€šçŸ¥ ============
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ github.event.inputs.telegram_chat_id || '-1003444893572' }}" \
            -e TELEGRAM_NOTIFY_ENABLED=false \
            -e TELEGRAM_NOTIFY_URL="https://code.easyllms.com/api/telegram/send" \
            -e TELEGRAM_TIMEOUT_S=10 \
            \
            # ============ äººå·¥å®¡æ‰¹é…ç½® ============
            -e APPROVAL_REQUIRED=true \
            -e APPROVAL_TIMEOUT_MINUTES=30 \
            -e APPROVAL_POLL_INTERVAL_SECONDS=60 \
            \
            # ============ é£æ§é…ç½® ============
            -e RISK_MAX_ITERATIONS=5 \
            -e RISK_MAX_REVISION_ROUNDS=5 \
            \
            # ============ æ‰§è¡Œé…ç½® ============
            -e EXECUTOR_PRICE_CAP_BUFFER=2 \
            \
            # ============ è®°å¿†ç³»ç»Ÿ ============
            -e MEMORY_TRADE_HISTORY_DAYS=30 \
            -e MEMORY_CONVERSATION_ROUNDS=10 \
            -e MEMORY_INSIGHT_TTL_DAYS=7 \
            \
            # ============ äº¤æ˜“æ—¶é—´çª—å£ ============
            -e TRADING_TIMEZONE="America/New_York" \
            -e TRADING_RTH_ONLY=true \
            -e TRADING_START_HHMM="09:35" \
            -e TRADING_END_HHMM="15:55" \
            \
            # ============ ä»“ä½æ§åˆ¶ ============
            -e MIN_TRADE_VALUE_USD=50 \
            -e MAX_POSITIONS=20 \
            -e MAX_POSITION_WEIGHT=0.10 \
            -e SLIPPAGE_BPS=15 \
            \
            ghcr.io/yjq001/ibkr:latest
      
      - name: Send Telegram notification
        if: always()
        run: |
          # åˆ¤æ–­å·¥ä½œæµçŠ¶æ€
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
          fi
          
          # è·å–å·¥ä½œæµä¿¡æ¯
          WORKFLOW_NAME="${{ github.workflow }}"
          RUN_NUMBER="${{ github.run_number }}"
          RUN_ID="${{ github.run_id }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          PROVIDER="${{ steps.set_llm_config.outputs.provider || 'gemini' }}"
          MODEL="${{ steps.set_llm_config.outputs.model || 'gemini-3-flash-preview' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          CHAT_ID="${{ github.event.inputs.telegram_chat_id || '-1003444893572' }}"
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹
          MESSAGE="${STATUS_EMOJI} *å·¥ä½œæµæ‰§è¡Œ${STATUS_TEXT}*

ğŸ“‹ *å·¥ä½œæµä¿¡æ¯*
â€¢ åç§°: ${WORKFLOW_NAME}
â€¢ è¿è¡Œç¼–å·: #${RUN_NUMBER}
â€¢ è§¦å‘è€…: ${ACTOR}
â€¢ ä»“åº“: ${REPO}

ğŸ¤– *ç­–ç•¥é…ç½®*
â€¢ æä¾›å•†: ${PROVIDER}
â€¢ æ¨¡å‹: ${MODEL}
â€¢ æ¨¡æ‹Ÿæ¨¡å¼: ${DRY_RUN}

ğŸ”— *æŸ¥çœ‹è¯¦æƒ…*
[æŸ¥çœ‹è¿è¡Œæ—¥å¿—](https://github.com/${REPO}/actions/runs/${RUN_ID})"
          
          # ä½¿ç”¨ Python æ„å»º JSONï¼ˆå®‰å…¨å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼‰
          python3 <<PYTHON_SCRIPT
import json
import os

message = """${MESSAGE}"""
chat_id = "${CHAT_ID}"

payload = {
    "chat_id": chat_id,
    "text": message,
    "parse_mode": "Markdown",
    "disable_web_page_preview": True
}

with open("/tmp/telegram_message.json", "w", encoding="utf-8") as f:
    json.dump(payload, f, ensure_ascii=False, indent=2)
PYTHON_SCRIPT
          
          # å‘é€ Telegram æ¶ˆæ¯
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d @/tmp/telegram_message.json \
            --fail --show-error || echo "Telegram notification failed, but continuing workflow"

