name: ğŸ“± Build StockGate APK

on:
  workflow_dispatch:
    inputs:
      source_repo:
        description: 'æºä»£ç ä»“åº“ (æ ¼å¼: owner/repo)'
        required: true
        default: 'yjq001/sex-robot'
      source_branch:
        description: 'æºä»£ç åˆ†æ”¯'
        required: true
        default: 'master'
      app_version:
        description: 'Appç‰ˆæœ¬å·'
        required: false
        default: '1.0.0'

jobs:
  build-apk:
    name: ğŸš€ æ„å»º StockGate APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æ‹‰å–æºä»£ç 
      uses: actions/checkout@v4
      with:
        repository: ${{ github.event.inputs.source_repo }}
        ref: ${{ github.event.inputs.source_branch }}
        token: ${{ secrets.PAT_TOKEN }}
        path: ./source-code
        
    - name: â˜• è®¾ç½® Java ç¯å¢ƒ
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± è®¾ç½® Android SDK
      uses: android-actions/setup-android@v3
      
    - name: ğŸ”§ è®¾ç½® Node.js ç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: './source-code/app/StockGateApp/package.json'
        
    - name: ğŸ“‚ å¤åˆ¶æºä»£ç åˆ°å·¥ä½œç›®å½•
      run: |
        echo "ğŸ“‚ å¤åˆ¶ StockGateApp æºä»£ç ..."
        cp -r ./source-code/app/StockGateApp ./stockgate-app
        cd ./stockgate-app
        
        echo "ğŸ“‹ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        echo "ğŸ“„ package.json å†…å®¹:"
        cat package.json
        
    - name: ğŸ“¦ å®‰è£…ä¾èµ–
      working-directory: ./stockgate-app
      run: |
        echo "ğŸ“¦ å®‰è£… npm ä¾èµ–..."
        npm install
        
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼Œå½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
    - name: ğŸ“¦ å‡†å¤‡ web èµ„æº
      working-directory: ./stockgate-app
      run: |
        mkdir -p www
        cp index.html www/
        
    - name: ğŸ—ï¸ æ·»åŠ  Android å¹³å°
      working-directory: ./stockgate-app
      run: |
        echo "ğŸ—ï¸ æ·»åŠ  Android å¹³å°..."
        npx cap add android
        
        echo "âš¡ åŒæ­¥é¡¹ç›®..."
        npx cap sync android
        
        echo "ğŸ“ æ£€æŸ¥ android ç›®å½•:"
        ls -la android/
        
    - name: ï¿½ï¿½ æ£€æŸ¥ logo.png å’Œç›®æ ‡ç›®å½•
      working-directory: ./stockgate-app
      run: |
        echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
        ls -lh
        echo "logo.png æ–‡ä»¶ä¿¡æ¯ï¼š"
        file logo.png || true
        echo "ç›®æ ‡ mipmap ç›®å½•å†…å®¹ï¼š"
        ls -lh android/app/src/main/res/ | grep mipmap || true

    - name: ğŸ¨ æ›¿æ¢ Android åº”ç”¨å›¾æ ‡
      working-directory: ./stockgate-app
      run: |
        sudo apt-get update && sudo apt-get install -y imagemagick
        set -x
        convert logo.png -resize 48x48 android/app/src/main/res/mipmap-mdpi/ic_launcher.png
        convert logo.png -resize 72x72 android/app/src/main/res/mipmap-hdpi/ic_launcher.png
        convert logo.png -resize 96x96 android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
        convert logo.png -resize 144x144 android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
        convert logo.png -resize 192x192 android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        echo "æ›¿æ¢åå„ç›®å½•å†…å®¹ï¼š"
        ls -lh android/app/src/main/res/mipmap-*/ic_launcher.png || true
        
    - name: ğŸ”§ é…ç½® Android æ„å»º
      working-directory: ./stockgate-app
      run: |
        echo "ğŸ”§ é…ç½® Gradle æ„å»º..."
        
        # ä¿®æ”¹ android/variables.gradle è®¾ç½®ç‰ˆæœ¬
        sed -i "s/versionName = .*/versionName = \"${{ github.event.inputs.app_version }}\"/" android/variables.gradle
        
        # ç¡®ä¿ gradlew æœ‰æ‰§è¡Œæƒé™
        chmod +x android/gradlew
        
        echo "ğŸ“‹ å½“å‰é…ç½®:"
        cat android/variables.gradle
        
    - name: ğŸ”‘ åˆ›å»ºç­¾åå¯†é’¥
      working-directory: ./stockgate-app/android
      run: |
        echo "ğŸ”‘ åˆ›å»º APK ç­¾åå¯†é’¥..."
        keytool -genkey -v -keystore stockgate.keystore \
          -alias stockgate \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=StockGate, OU=App, O=StockGate Inc, L=Beijing, S=Beijing, C=CN" \
          -storepass stockgate123 \
          -keypass stockgate123
          
        echo "âœ… å¯†é’¥åˆ›å»ºå®Œæˆ"
        ls -la *.keystore
        
    - name: ğŸ—ï¸ æ„å»º Debug APK
      working-directory: ./stockgate-app/android
      run: |
        echo "ğŸ—ï¸ æ„å»º Debug APK..."
        ./gradlew assembleDebug
        
        echo "ğŸ“± Debug APK æ„å»ºå®Œæˆ:"
        find . -name "*.apk" -path "*/debug/*"
        
    - name: ğŸ—ï¸ æ„å»º Release APK
      working-directory: ./stockgate-app/android
      run: |
        echo "ğŸ—ï¸ æ„å»º Release APK..."
        
        # é…ç½®ç­¾åä¿¡æ¯
        echo "android.injected.signing.store.file=$(pwd)/stockgate.keystore" >> gradle.properties
        echo "android.injected.signing.store.password=stockgate123" >> gradle.properties
        echo "android.injected.signing.key.alias=stockgate" >> gradle.properties
        echo "android.injected.signing.key.password=stockgate123" >> gradle.properties
        
        # æ„å»º Release APK
        ./gradlew assembleRelease
        
        echo "ğŸ“± Release APK æ„å»ºå®Œæˆ:"
        find . -name "*.apk" -path "*/release/*"
        
    - name: ğŸ“ é‡å‘½å APK æ–‡ä»¶
      working-directory: ./stockgate-app/android
      run: |
        echo "ğŸ“ é‡å‘½å APK æ–‡ä»¶..."
        
        # æ‰¾åˆ°å¹¶é‡å‘½å Debug APK
        DEBUG_APK=$(find . -name "*.apk" -path "*/debug/*" | head -1)
        if [ -f "$DEBUG_APK" ]; then
          cp "$DEBUG_APK" "StockGate-${{ github.event.inputs.app_version }}-debug.apk"
          echo "âœ… Debug APK: StockGate-${{ github.event.inputs.app_version }}-debug.apk"
        fi
        
        # æ‰¾åˆ°å¹¶é‡å‘½å Release APK
        RELEASE_APK=$(find . -name "*.apk" -path "*/release/*" | head -1)
        if [ -f "$RELEASE_APK" ]; then
          cp "$RELEASE_APK" "StockGate-${{ github.event.inputs.app_version }}-release.apk"
          echo "âœ… Release APK: StockGate-${{ github.event.inputs.app_version }}-release.apk"
        fi
        
        echo "ğŸ“Š æœ€ç»ˆ APK æ–‡ä»¶:"
        ls -lh StockGate-*.apk
        
    - name: ğŸ“Š APK ä¿¡æ¯ç»Ÿè®¡
      working-directory: ./stockgate-app/android
      run: |
        echo "ğŸ“Š StockGate APK æ„å»ºä¿¡æ¯"
        echo "================================"
        echo "ğŸ“… æ„å»ºæ—¶é—´: $(date)"
        echo "ğŸ·ï¸ ç‰ˆæœ¬å·: ${{ github.event.inputs.app_version }}"
        echo "ğŸ“¦ æºä»£ç ä»“åº“: ${{ github.event.inputs.source_repo }}"
        echo "ğŸŒ¿ æºä»£ç åˆ†æ”¯: ${{ github.event.inputs.source_branch }}"
        echo ""
        
        if [ -f "StockGate-${{ github.event.inputs.app_version }}-debug.apk" ]; then
          echo "ğŸ”§ Debug APK å¤§å°: $(du -h "StockGate-${{ github.event.inputs.app_version }}-debug.apk" | cut -f1)"
        fi
        
        if [ -f "StockGate-${{ github.event.inputs.app_version }}-release.apk" ]; then
          echo "ğŸš€ Release APK å¤§å°: $(du -h "StockGate-${{ github.event.inputs.app_version }}-release.apk" | cut -f1)"
        fi
        
        echo "================================"
        
    - name: ğŸ“¤ ä¸Šä¼  Debug APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: StockGate-${{ github.event.inputs.app_version }}-debug
        path: ./stockgate-app/android/StockGate-${{ github.event.inputs.app_version }}-debug.apk
        retention-days: 30
        
    - name: ğŸ“¤ ä¸Šä¼  Release APK
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: StockGate-${{ github.event.inputs.app_version }}-release
        path: ./stockgate-app/android/StockGate-${{ github.event.inputs.app_version }}-release.apk
        retention-days: 90
        
    - name: ğŸ‰ æ„å»ºå®Œæˆ
      run: |
        echo "ğŸ‰ StockGate APK æ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
        echo "1. åœ¨ GitHub Actions é¡µé¢ç‚¹å‡»æœ¬æ¬¡è¿è¡Œ"
        echo "2. æ»šåŠ¨åˆ°åº•éƒ¨çš„ 'Artifacts' åŒºåŸŸ"  
        echo "3. ä¸‹è½½å¯¹åº”çš„ APK æ–‡ä»¶"
        echo ""
        echo "ğŸ“± APK è¯´æ˜:"
        echo "- Debug APK: ç”¨äºå¼€å‘æµ‹è¯•ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯"
        echo "- Release APK: ç”¨äºæ­£å¼å‘å¸ƒï¼Œå·²ä¼˜åŒ–å’Œç­¾å"
        echo ""
        echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
