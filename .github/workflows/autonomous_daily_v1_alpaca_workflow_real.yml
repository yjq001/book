name: Á≠ñÁï•-Autonomous Daily V1 Trading (Alpaca-Real)

on:
  schedule:
    # Áæé‰∏úÊó∂Èó¥‰∏ãÂçà 15:00 ÊâßË°åÔºàÂë®‰∏ÄÂà∞Âë®‰∫îÔºâ
    # UTC 19:00 ÂØπÂ∫î EDT 15:00ÔºàÂ§è‰ª§Êó∂Ôºå3Êúà-11ÊúàÔºâ
    # UTC 19:00 ÂØπÂ∫î EST 14:00ÔºàÂÜ¨‰ª§Êó∂Ôºå11Êúà-3ÊúàÔºâ
    - cron: '31 19 * * 1-5'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      autonomous_provider:
        description: 'LLM Provider'
        required: false
        type: choice
        default: 'gemini'
        options:
          - gemini
          - openai
          - openrouter
      autonomous_model:
        description: 'LLM Model name (leave empty to use default for selected provider)'
        required: false
        default: 'gemini-3-flash-preview'
      telegram_chat_id:
        description: 'Telegram Chat ID'
        required: false
        default: '-1003444893572'
      dry_run:
        description: 'Dry Run Mode (true/false)'
        required: false
        default: 'true'

jobs:
  run_autonomous_daily_v1_alpaca:
    runs-on: ubuntu-latest
    timeout-minutes: 50
    
    steps:
      - name: Set LLM configuration based on provider
        id: set_llm_config
        run: |
          PROVIDER="${{ github.event.inputs.autonomous_provider || 'gemini' }}"
          CUSTOM_MODEL="${{ github.event.inputs.autonomous_model }}"
          
          # Ê†πÊçÆÊèê‰æõÂïÜËÆæÁΩÆÈªòËÆ§Ê®°Âûã
          case "$PROVIDER" in
            openai)
              DEFAULT_MODEL="gpt-5-mini"
              ;;
            gemini)
              DEFAULT_MODEL="gemini-3-flash-preview"
              ;;
            openrouter)
              DEFAULT_MODEL="openai/gpt-4o-mini"
              ;;
            *)
              DEFAULT_MODEL="gemini-3-flash-preview"
              ;;
          esac
          
          # Â¶ÇÊûúÁî®Êà∑Êèê‰æõ‰∫ÜËá™ÂÆö‰πâÊ®°ÂûãÔºå‰ΩøÁî®Ëá™ÂÆö‰πâÊ®°ÂûãÔºõÂê¶Âàô‰ΩøÁî®ÈªòËÆ§Ê®°Âûã
          if [ -n "$CUSTOM_MODEL" ]; then
            MODEL="$CUSTOM_MODEL"
          else
            MODEL="$DEFAULT_MODEL"
          fi
          
          echo "provider=$PROVIDER" >> $GITHUB_OUTPUT
          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "Using provider: $PROVIDER, model: $MODEL"
      
      - name: Run autonomous daily v1 strategy with Alpaca
        run: |
          docker pull ghcr.io/yjq001/ibkr:latest
          
          docker run --rm --network host \
            --name autonomous_daily_v1_alpaca \
            -e USE_MOCK_BROKER=false \
            -e BROKER_TYPE=alpaca \
            -e ALPACA_API_KEY="${{ secrets.ALPACA_API_KEY_REAL }}" \
            -e ALPACA_API_SECRET="${{ secrets.ALPACA_API_SECRET_REAL }}" \
            -e ALPACA_BASE_URL="https://api.alpaca.markets" \
            -e DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}" \
            -e STRATEGY_NAME="autonomous_daily_v1" \
            -e OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}" \
            -e OPENAI_MODEL="gpt-4o-mini" \
            -e GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
            -e OPENROUTER_API_KEY="${{ secrets.OPENROUTER_API_KEY }}" \
            -e OPENROUTER_HTTP_REFERER="https://github.com/easyllms/ibkr-bot" \
            -e OPENROUTER_APP_NAME="IBKR Bot" \
            -e AUTONOMOUS_PROVIDER="${{ steps.set_llm_config.outputs.provider || 'gemini' }}" \
            -e AUTONOMOUS_MODEL="${{ steps.set_llm_config.outputs.model || 'gemini-3-flash-preview' }}" \
            -e LLM_STREAMING=true \
            -e STRATEGIST_PROVIDER="openai" \
            -e STRATEGIST_MODEL="o4-mini" \
            -e MCP_SERVER_URL="${{ secrets.MCP_SERVER_URL || '' }}" \
            -e UPSTASH_REDIS_URL="https://smashing-spaniel-32228.upstash.io" \
            -e UPSTASH_REDIS_TOKEN="${{ secrets.UPSTASH_REDIS_TOKEN }}" \
            -e TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
            -e TELEGRAM_CHAT_ID="${{ github.event.inputs.telegram_chat_id || '-1003444893572' }}" \
            -e TELEGRAM_NOTIFY_ENABLED=false \
            -e TELEGRAM_NOTIFY_URL="https://code.easyllms.com/api/telegram/send" \
            -e TELEGRAM_TIMEOUT_S=10 \
            -e APPROVAL_REQUIRED=false \
            -e APPROVAL_TIMEOUT_MINUTES=30 \
            -e APPROVAL_POLL_INTERVAL_SECONDS=60 \
            -e RISK_MAX_ITERATIONS=5 \
            -e RISK_MAX_REVISION_ROUNDS=5 \
            -e EXECUTOR_PRICE_CAP_BUFFER=2 \
            -e MEMORY_TRADE_HISTORY_DAYS=30 \
            -e MEMORY_CONVERSATION_ROUNDS=10 \
            -e MEMORY_INSIGHT_TTL_DAYS=7 \
            -e TRADING_TIMEZONE="America/New_York" \
            -e TRADING_RTH_ONLY=true \
            -e TRADING_START_HHMM="09:35" \
            -e TRADING_END_HHMM="15:55" \
            -e MIN_TRADE_VALUE_USD=50 \
            -e MAX_POSITIONS=20 \
            -e MAX_POSITION_WEIGHT=0.10 \
            -e SLIPPAGE_BPS=15 \
            -e DIARY_TITLE="AIÊâìÂ∑•‰∫∫-alpacaÂÆûÁõò" \
            -e INITIAL_CAPITAL="10000" \
            ghcr.io/yjq001/ibkr:latest ibkr-bot run-once
      
      - name: Send Telegram notification
        if: always()
        run: |
          # Âà§Êñ≠Â∑•‰ΩúÊµÅÁä∂ÊÄÅ
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="ÊàêÂäü"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Â§±Ë¥•"
          fi
          
          # Ëé∑ÂèñÂ∑•‰ΩúÊµÅ‰ø°ÊÅØ
          WORKFLOW_NAME="${{ github.workflow }}"
          RUN_NUMBER="${{ github.run_number }}"
          RUN_ID="${{ github.run_id }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          PROVIDER="${{ steps.set_llm_config.outputs.provider || 'gemini' }}"
          MODEL="${{ steps.set_llm_config.outputs.model || 'gemini-3-flash-preview' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          CHAT_ID="${{ github.event.inputs.telegram_chat_id || '-1003444893572' }}"
          
          # ÊûÑÂª∫Ê∂àÊÅØÂÜÖÂÆπ
          MESSAGE=$(cat <<EOF
          ${STATUS_EMOJI} *Â∑•‰ΩúÊµÅÊâßË°å${STATUS_TEXT}*

          üìã *Â∑•‰ΩúÊµÅ‰ø°ÊÅØ*
          ‚Ä¢ ÂêçÁß∞: ${WORKFLOW_NAME}
          ‚Ä¢ ËøêË°åÁºñÂè∑: #${RUN_NUMBER}
          ‚Ä¢ Ëß¶ÂèëËÄÖ: ${ACTOR}
          ‚Ä¢ ‰ªìÂ∫ì: ${REPO}

          ü§ñ *Á≠ñÁï•ÈÖçÁΩÆ*
          ‚Ä¢ Êèê‰æõÂïÜ: ${PROVIDER}
          ‚Ä¢ Ê®°Âûã: ${MODEL}
          ‚Ä¢ Ê®°ÊãüÊ®°Âºè: ${DRY_RUN}
          ‚Ä¢ Broker: Alpaca

          üîó *Êü•ÁúãËØ¶ÊÉÖ*
          [Êü•ÁúãËøêË°åÊó•Âøó](https://github.com/${REPO}/actions/runs/${RUN_ID})
          EOF
          )
          
          # ‰ΩøÁî® Python ÊûÑÂª∫ JSONÔºàÂÆâÂÖ®Â§ÑÁêÜÁâπÊÆäÂ≠óÁ¨¶Ôºâ
          export MESSAGE CHAT_ID
          python3 <<'PYTHON_SCRIPT'
          import json
          import os
          
          message = os.environ.get('MESSAGE', '')
          chat_id = os.environ.get('CHAT_ID', '')
          
          payload = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "Markdown",
              "disable_web_page_preview": True
          }
          
          with open("/tmp/telegram_message.json", "w", encoding="utf-8") as f:
              json.dump(payload, f, ensure_ascii=False, indent=2)
          PYTHON_SCRIPT
          
          # ÂèëÈÄÅ Telegram Ê∂àÊÅØ
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d @/tmp/telegram_message.json \
            --fail --show-error || echo "Telegram notification failed, but continuing workflow"
      

