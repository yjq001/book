name: Docker Build ibkr (amd64) and Push

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      ref:
        description: '要检出的分支、标签或提交SHA'
        required: true
        default: 'master'
        type: string
      version:
        description: 'Docker镜像版本标签（手动触发时使用）'
        required: false
        default: 'latest'
        type: string

env:
  REGISTRY: ghcr.io
  SOURCE_REPO: yjq001/sex-robot
  IMAGE_NAME: ibkr
  IMAGE_OWNER: yjq001

jobs:
  build-and-push:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository (private)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SOURCE_REPO }}
          ref: ${{ inputs.ref || 'master' }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 1

      - name: Verify ibkr Docker build files
        run: |
          echo "检查 ibkr/ 目录..."
          ls -la ibkr

          echo "检查 ibkr/Dockerfile..."
          if [ -f "ibkr/Dockerfile" ]; then
            echo "✓ ibkr/Dockerfile 存在"
          else
            echo "✗ ibkr/Dockerfile 不存在!"
            exit 1
          fi

          echo "检查 ibkr/.dockerignore..."
          if [ -f "ibkr/.dockerignore" ]; then
            echo "✓ ibkr/.dockerignore 存在"
          else
            echo "✗ ibkr/.dockerignore 不存在，创建一个空文件"
            touch ibkr/.dockerignore
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker tags
        id: docker_tags
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.version || 'latest' }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            TAG="${{ github.ref_name }}"
          else
            TAG="${{ github.ref_name || 'latest' }}"
          fi

          echo "使用标签: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          FULL_IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_OWNER }}/${{ env.IMAGE_NAME }}:$TAG"
          echo "image=$FULL_IMAGE_NAME" >> $GITHUB_OUTPUT

      - name: Build and push Docker image (amd64)
        run: |
          echo "开始构建镜像: ${{ steps.docker_tags.outputs.image }} 平台: linux/amd64"
          docker buildx build --platform linux/amd64 \
            --push \
            --tag ${{ steps.docker_tags.outputs.image }} \
            --file ibkr/Dockerfile \
            ibkr
          echo "已推送镜像到 ${{ env.REGISTRY }}"

      - name: Image info
        if: success()
        run: |
          echo "构建成功!"
          echo "镜像: ${{ steps.docker_tags.outputs.image }}"
          echo "架构: linux/amd64"

